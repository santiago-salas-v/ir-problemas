<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>


      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"><!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>resolverCSTR</title>
   <meta name="generator" content="MATLAB 7.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2013-12-08"><meta name="DC.source" content="resolverCSTR.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><pre class="codeinput"><span class="keyword">function</span> Datos_struct_final = resolverCSTR(Datos_struct)
<span class="comment">%RESOLVERCSTR Resuelve los perfiles para CSTR</span>
Isot=Datos_struct.Isot;
Estacionario=Datos_struct.Estacionario;
Incompresible=Datos_struct.Incompresible;
Coefs_esteq=Datos_struct.Coefs_esteq;
nComps=Datos_struct.nComps;
reactivosSonCompsNo=Datos_struct.reactivosSonCompsNo;
productosSonCompsNo=Datos_struct.productosSonCompsNo;
Ref_Selectividad=Datos_struct.Ref_Selectividad;
Ref_Rendimiento=Datos_struct.Ref_Rendimiento;
delta_Hf=Datos_struct.delta_Hf;
E=Datos_struct.E;
k0=Datos_struct.k0;
Exponentes_r=Datos_struct.Exponentes_r;
T0ref=Datos_struct.T0ref;
U=Datos_struct.U;
A=Datos_struct.A;
Va=Datos_struct.Va;
Vr=Datos_struct.Vr;
T0=Datos_struct.T0;
T_t0=Datos_struct.T_t0;
Q0=Datos_struct.Q0;
C0=Datos_struct.C0;
C_t0=Datos_struct.C_t0;
Ta0=Datos_struct.Ta0;
Qa0=Datos_struct.Qa0;<span class="comment">%L/min</span>
rhoCp_a=Datos_struct.rhoCp_a;
CpMolares=Datos_struct.CpMolares;
R=Datos_struct.R;
tiempo_tot=Datos_struct.tiempo_tot;
Tmax=Datos_struct.Tmax;


<span class="keyword">if</span> Estacionario
    t=inf;
    <span class="keyword">if</span> Isot
        T=1e-4:(Tmax-1e-4)/70:Tmax;
        T0=T;
    <span class="keyword">elseif</span> ~Isot
        T=1e-4:(Tmax-1e-4)/70:Tmax;
    <span class="keyword">end</span>
    C=NaN*zeros(nComps,size(T,2));
    Ta=NaN*zeros(1,size(T,2));
    Qa=Qa0*zeros(1,size(T,2));
    EstimarC=C0';
    options=optimset(<span class="string">'Display'</span>,<span class="string">'off'</span>,<span class="string">'TolFun'</span>,1e-10);
    BarraDeEstado=waitbar(0,<span class="string">' '</span>,<span class="string">'Name'</span>,<span class="string">'Calculando Edos. Est.'</span>,<span class="keyword">...</span>
        <span class="string">'CreateCancelBtn'</span>,<span class="string">'setappdata(gcbf,''canceling'',1)'</span>);
    setappdata(BarraDeEstado,<span class="string">'canceling'</span>,0);
    <span class="keyword">for</span> j=1:length(T)
        <span class="keyword">if</span> getappdata(BarraDeEstado,<span class="string">'canceling'</span>)
            <span class="keyword">break</span>
        <span class="keyword">end</span>
        estatus=[sprintf(<span class="string">'%u'</span>,round(j/length(T)*100)) <span class="string">'%'</span>];
        waitbar(j/length(T),BarraDeEstado,estatus);
        C(:,j)=fsolve(@(y)<span class="keyword">...</span>
            <span class="keyword">...</span>
            Q0/Vr*(C0'-y)+<span class="keyword">...</span>
            Coefs_esteq'*rapideces(y,<span class="keyword">...</span>
            T(j),Exponentes_r,k0,E,R,T0ref)<span class="keyword">...</span>
            <span class="keyword">...</span>
            ,EstimarC,options);
        Ta(j)=T(j)-(T(j)-Ta0)*exp(-U*A./(Qa0*rhoCp_a));
        <span class="keyword">if</span> norm(Ta(j)-Ta0)==0
            Qa(j)=-Va/(Ta0-Ta(j)).*<span class="keyword">...</span>
                -U*A./(Va*rhoCp_a).*<span class="keyword">...</span>
                (Ta(j)-T(j));
        <span class="keyword">else</span>
            Qa(j)=-Va/(Ta0-Ta(j)).*<span class="keyword">...</span>
                -U*A./(Va*rhoCp_a).*<span class="keyword">...</span>
                (Ta(j)-Ta0)/log((Ta(j)-T(j))/(Ta0-T(j)));
        <span class="keyword">end</span>
        EstimarC=C(:,j);
    <span class="keyword">end</span>
    delete(BarraDeEstado);
    sol.C=C;
    sol.Ta=Ta;
    sol.Qa=Qa;<span class="comment">%L/min</span>
    [r,k]=rapideces(C,T,Exponentes_r,k0,E,R,T0ref);
    rho_Cp=CpMolares*C;
    qgen=1./(rho_Cp).*(sum(<span class="keyword">...</span>
        (-delta_Hr(T,delta_Hf,Coefs_esteq,CpMolares))'.*r<span class="keyword">...</span>
        ,1));
    qrem=-Q0/Vr*(CpMolares*C0'./(rho_Cp)).*<span class="keyword">...</span>
        (T0-T)+<span class="keyword">...</span>
        -(Qa0*rhoCp_a)./(Vr*rho_Cp).*(Ta0-T)*(1-exp(-U*A./(Qa0*rhoCp_a)));
    <span class="keyword">try</span>
        <span class="comment">% crossing.m</span>
        <span class="comment">% http://www.mathworks.com/matlabcentral/fileexchange/2432-crossing</span>
        [~,T_Edos_Est]=crossing(qrem-qgen,T);
        C_Edos_Est=interp1(T,C',T_Edos_Est)';
        Ta_Edos_Est=interp1(T,Ta,T_Edos_Est);
        r_Edos_Est=interp1(T,r',T_Edos_Est)';
        k_Edos_Est=interp1(T,k',T_Edos_Est)';
        qrem_Edos_Est=interp1(T,qrem,T_Edos_Est);
        qgen_Edos_Est=interp1(T,qgen,T_Edos_Est);
    <span class="keyword">catch</span> exception
        <span class="keyword">if</span> strcmp(exception.message,<span class="keyword">...</span>
                <span class="string">'No zero crossings found in this sample for fzero'</span>)
            T_Edos_Est=NaN;
            C_Edos_Est=NaN;
            Ta_Edos_Est=NaN;
            r_Edos_Est=NaN;
            k_Edos_Est=NaN;
            qrem_Edos_Est=NaN;
            qgen_Edos_Est=NaN;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">elseif</span> ~Estacionario
    <span class="keyword">if</span> Isot
        T=T0;
        <span class="keyword">if</span> Incompresible
            M=eye(nComps+1);<span class="comment">%cm/min</span>
            odeOptions=odeset(<span class="string">'Mass'</span>,M,<span class="string">'OutputFcn'</span>,@odeprog,<span class="keyword">...</span>
                <span class="string">'Events'</span>,@odeabort);
            <span class="comment">%Resolver IVP para sistema de EDO</span>
            <span class="comment">%Considerar forma M*y'=f(z,y), especificar f(z,y) como</span>
            <span class="comment">%@(z,y)</span>
            sol=ode15s(@(t,y)<span class="keyword">...</span>
                <span class="keyword">...</span>
                [<span class="keyword">...</span>
                Q0/Vr*(C0'-y(1:end-1))+<span class="keyword">...</span>
                Coefs_esteq'*rapideces(y(1:end-1),<span class="keyword">...</span>
                T0,Exponentes_r,k0,E,R,T0ref);<span class="keyword">...</span>
                <span class="keyword">...</span>
                Qa0/Va*(Ta0-y(end))+<span class="keyword">...</span>
                -U*A./(Va*rhoCp_a).*<span class="keyword">...</span>
                (y(end)-Ta0)/log((y(end)-T0)/(Ta0-T0));<span class="keyword">...</span>
                ]<span class="keyword">...</span>
                <span class="keyword">...</span>
                ,[0,tiempo_tot],[C0,Ta0+1e-10],odeOptions);
            t=sol.x;
            C=sol.y(1:end-1,:);
            T=T0*ones(size(t));
            Ta=sol.y(end,:);
        <span class="keyword">elseif</span> ~Incompresible
        <span class="keyword">end</span>
    <span class="keyword">elseif</span> ~Isot
        <span class="keyword">if</span> Incompresible
            M=eye(nComps+2);<span class="comment">%cm/min</span>
            M(1:end-1,1:end-1)=M(1:end-1,1:end-1);
            M(end,end)=M(end,end);
            odeOptions=odeset(<span class="string">'Mass'</span>,M,<span class="string">'OutputFcn'</span>,@odeprog,<span class="keyword">...</span>
                <span class="string">'Events'</span>,@odeabort);
            <span class="comment">%Resolver IVP para sistema de EDO</span>
            <span class="comment">%Considerar forma M*y'=f(z,y), especificar f(z,y) como</span>
            <span class="comment">%@(z,y)</span>
            sol=ode15s(@(t,y)<span class="keyword">...</span>
                <span class="keyword">...</span>
                [<span class="keyword">...</span>
                Q0/Vr*(C0'-y(1:end-2))+<span class="keyword">...</span>
                Coefs_esteq'*rapideces(y(1:end-2),<span class="keyword">...</span>
                y(end-1),Exponentes_r,k0,E,R,T0ref);<span class="keyword">...</span>
                <span class="keyword">...</span>
                Q0/Vr*(CpMolares*C0'./(CpMolares*y(1:end-2))).*<span class="keyword">...</span>
                (T0-y(end-1))+<span class="keyword">...</span>
                (1./(CpMolares*y(1:end-2))).*<span class="keyword">...</span>
                (-delta_Hr(y(end-1),delta_Hf,Coefs_esteq,CpMolares)*<span class="keyword">...</span>
                rapideces(y(1:end-2),<span class="keyword">...</span>
                y(end-1),Exponentes_r,k0,E,R,T0ref))+<span class="keyword">...</span>
                +U*A./(Vr*CpMolares*y(1:end-2)).*<span class="keyword">...</span>
                (y(end)-Ta0)/log((y(end)-y(end-1))/(Ta0-y(end-1)));<span class="keyword">...</span>
                <span class="keyword">...</span>
                Qa0/Va*(Ta0-y(end))+<span class="keyword">...</span>
                -U*A./(Va*rhoCp_a).*<span class="keyword">...</span>
                (y(end)-Ta0)/log((y(end)-y(end-1))/(Ta0-y(end-1)));<span class="keyword">...</span>
                ]<span class="keyword">...</span>
                <span class="keyword">...</span>
                ,[0,tiempo_tot],<span class="keyword">...</span>
                [C_t0,T_t0,Ta0+1e-10],odeOptions);
            t=sol.x;
            C=sol.y(1:end-2,:);
            T=sol.y(end-1,:);
            Ta=sol.y(end,:);
        <span class="keyword">elseif</span> ~Incompresible
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    [r,k]=rapideces(C,T,Exponentes_r,k0,E,R,T0ref);
    rho_Cp=CpMolares*C;
    qgen=1./(rho_Cp).*(sum(<span class="keyword">...</span>
        (-delta_Hr(T,delta_Hf,Coefs_esteq,CpMolares))'.*r<span class="keyword">...</span>
        ,1));
    qrem=-Q0/Vr*(CpMolares*C0'./(CpMolares*C)).*<span class="keyword">...</span>
        (T0-T)+<span class="keyword">...</span>
        -(Qa0*rhoCp_a)./(Vr*rho_Cp).*(Ta0-T)*(1-exp(-U*A./(Qa0*rhoCp_a)));
    Qa=Qa0*ones(size(T));
    T_Edos_Est=Datos_struct.T_Edos_Est;
    C_Edos_Est=Datos_struct.C_Edos_Est;
    Ta_Edos_Est=Datos_struct.Ta_Edos_Est;
    r_Edos_Est=Datos_struct.r_Edos_Est;
    k_Edos_Est=Datos_struct.k_Edos_Est;
    qrem_Edos_Est=Datos_struct.qrem_Edos_Est;
    qgen_Edos_Est=Datos_struct.qgen_Edos_Est;
<span class="keyword">end</span>

Q=Q0*ones(size(T));

X=NaN*zeros(size(C));
Y=NaN*zeros(size(C));
S=NaN*zeros(size(C));
Yconsumo=NaN*zeros(size(C));
<span class="comment">%CONVERSIÓN</span>
<span class="keyword">for</span> j=1:size(C,1)
    <span class="keyword">if</span> ismember(j,reactivosSonCompsNo)
        X(j,:)=<span class="keyword">...</span>
                (Q0*C0(j)-Q0*C(j,:))./<span class="keyword">...</span>
                (Q0*C0(j));
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">%RENDIMIENTO POR ALIMENTACIÓN</span>
<span class="keyword">for</span> j=1:size(C,1)
    <span class="keyword">if</span> ismember(j,productosSonCompsNo)
        Y(j,:)=<span class="keyword">...</span>
                (Q0*C(j,:)-Q0*C0(j))./<span class="keyword">...</span>
                (Q0*C0(Ref_Rendimiento));
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">%RENDIMIENTO POR CONSUMO</span>
<span class="keyword">for</span> j=1:size(C,1)
    <span class="keyword">if</span> ismember(j,productosSonCompsNo)
        Yconsumo(j,:)=Y(j,:)./X(Ref_Rendimiento,:);
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">%SELECTIVIDAD</span>
<span class="keyword">for</span> j=1:size(C,1)
    <span class="keyword">if</span> j~=Ref_Selectividad &amp;&amp; ismember(j,productosSonCompsNo)
       S(j,:)=Y(j,:)./Y(Ref_Selectividad,:);
    <span class="keyword">end</span>
<span class="keyword">end</span>

warning(<span class="string">'off'</span>,<span class="string">'all'</span>);
<span class="keyword">if</span> Estacionario
    Q_Edos_Est=interp1(T,Q,T_Edos_Est);
    Qa_Edos_Est=interp1(T,Qa,T_Edos_Est);
    X_Edos_Est=interp1(T,X',T_Edos_Est)';
    Y_Edos_Est=interp1(T,Y',T_Edos_Est)';
    Yconsumo_Edos_Est=interp1(T,Yconsumo',T_Edos_Est)';
    S_Edos_Est=interp1(T,S',T_Edos_Est)';
<span class="keyword">elseif</span> ~Estacionario
    Q_Edos_Est=Datos_struct.Q_Edos_Est;
    Qa_Edos_Est=Datos_struct.Qa_Edos_Est;
    X_Edos_Est=Datos_struct.X_Edos_Est;
    Y_Edos_Est=Datos_struct.Y_Edos_Est;
    Yconsumo_Edos_Est=Datos_struct.Yconsumo_Edos_Est;
    S_Edos_Est=Datos_struct.S_Edos_Est;
<span class="keyword">end</span>
warning(<span class="string">'on'</span>,<span class="string">'all'</span>);

Datos_struct.sol=sol;
Datos_struct.t=t;
Datos_struct.C=C;
Datos_struct.X=X;
Datos_struct.Y=Y;
Datos_struct.Yconsumo=Yconsumo;
Datos_struct.S=S;
Datos_struct.T=T;
Datos_struct.Ta=Ta;
Datos_struct.T_Edos_Est=T_Edos_Est;
Datos_struct.r=r;
Datos_struct.k=k;
Datos_struct.qgen=qgen;
Datos_struct.qrem=qrem;
Datos_struct.q={qrem;qgen};
Datos_struct.Qa=Qa;
Datos_struct.Q=Q;

Datos_struct.C_Edos_Est=C_Edos_Est;
Datos_struct.X_Edos_Est=X_Edos_Est;
Datos_struct.Y_Edos_Est=Y_Edos_Est;
Datos_struct.Yconsumo_Edos_Est=Yconsumo_Edos_Est;
Datos_struct.S_Edos_Est=S_Edos_Est;
Datos_struct.T_Edos_Est=T_Edos_Est;
Datos_struct.Ta_Edos_Est=Ta_Edos_Est;
Datos_struct.r_Edos_Est=r_Edos_Est;
Datos_struct.k_Edos_Est=k_Edos_Est;
Datos_struct.qgen_Edos_Est=qgen_Edos_Est;
Datos_struct.qrem_Edos_Est=qrem_Edos_Est;
Datos_struct.q_Edos_Est=<span class="keyword">...</span>
    {qrem_Edos_Est;qgen_Edos_Est};
Datos_struct.Qa_Edos_Est=Qa_Edos_Est;
Datos_struct.Q_Edos_Est=Q_Edos_Est;

Datos_struct_final=Datos_struct;

<span class="keyword">end</span>
</pre><p class="footer"><br>
      Published with MATLAB® 7.13<br></p></div><!--
##### SOURCE BEGIN #####
function Datos_struct_final = resolverCSTR(Datos_struct)
%RESOLVERCSTR Resuelve los perfiles para CSTR
Isot=Datos_struct.Isot;
Estacionario=Datos_struct.Estacionario;
Incompresible=Datos_struct.Incompresible;
Coefs_esteq=Datos_struct.Coefs_esteq;
nComps=Datos_struct.nComps;
reactivosSonCompsNo=Datos_struct.reactivosSonCompsNo;
productosSonCompsNo=Datos_struct.productosSonCompsNo;
Ref_Selectividad=Datos_struct.Ref_Selectividad;
Ref_Rendimiento=Datos_struct.Ref_Rendimiento;
delta_Hf=Datos_struct.delta_Hf;
E=Datos_struct.E;
k0=Datos_struct.k0;
Exponentes_r=Datos_struct.Exponentes_r;
T0ref=Datos_struct.T0ref;
U=Datos_struct.U;
A=Datos_struct.A;
Va=Datos_struct.Va;
Vr=Datos_struct.Vr;
T0=Datos_struct.T0;
T_t0=Datos_struct.T_t0;
Q0=Datos_struct.Q0;
C0=Datos_struct.C0;
C_t0=Datos_struct.C_t0;
Ta0=Datos_struct.Ta0;
Qa0=Datos_struct.Qa0;%L/min
rhoCp_a=Datos_struct.rhoCp_a;
CpMolares=Datos_struct.CpMolares;
R=Datos_struct.R;
tiempo_tot=Datos_struct.tiempo_tot;
Tmax=Datos_struct.Tmax;
   

if Estacionario
    t=inf;
    if Isot
        T=1e-4:(Tmax-1e-4)/70:Tmax;
        T0=T;        
    elseif ~Isot
        T=1e-4:(Tmax-1e-4)/70:Tmax;           
    end
    C=NaN*zeros(nComps,size(T,2));
    Ta=NaN*zeros(1,size(T,2));
    Qa=Qa0*zeros(1,size(T,2));    
    EstimarC=C0';
    options=optimset('Display','off','TolFun',1e-10);
    BarraDeEstado=waitbar(0,' ','Name','Calculando Edos. Est.',...
        'CreateCancelBtn','setappdata(gcbf,''canceling'',1)');
    setappdata(BarraDeEstado,'canceling',0);
    for j=1:length(T)
        if getappdata(BarraDeEstado,'canceling')
            break
        end
        estatus=[sprintf('%u',round(j/length(T)*100)) '%'];
        waitbar(j/length(T),BarraDeEstado,estatus);
        C(:,j)=fsolve(@(y)...
            ...
            Q0/Vr*(C0'-y)+...
            Coefs_esteq'*rapideces(y,...
            T(j),Exponentes_r,k0,E,R,T0ref)...
            ...
            ,EstimarC,options);
        Ta(j)=T(j)-(T(j)-Ta0)*exp(-U*A./(Qa0*rhoCp_a));        
        if norm(Ta(j)-Ta0)==0
            Qa(j)=-Va/(Ta0-Ta(j)).*...
                -U*A./(Va*rhoCp_a).*...
                (Ta(j)-T(j));
        else
            Qa(j)=-Va/(Ta0-Ta(j)).*...
                -U*A./(Va*rhoCp_a).*...
                (Ta(j)-Ta0)/log((Ta(j)-T(j))/(Ta0-T(j)));
        end
        EstimarC=C(:,j);
    end
    delete(BarraDeEstado);
    sol.C=C;
    sol.Ta=Ta;
    sol.Qa=Qa;%L/min
    [r,k]=rapideces(C,T,Exponentes_r,k0,E,R,T0ref);
    rho_Cp=CpMolares*C;
    qgen=1./(rho_Cp).*(sum(...
        (-delta_Hr(T,delta_Hf,Coefs_esteq,CpMolares))'.*r...
        ,1));
    qrem=-Q0/Vr*(CpMolares*C0'./(rho_Cp)).*...
        (T0-T)+...
        -(Qa0*rhoCp_a)./(Vr*rho_Cp).*(Ta0-T)*(1-exp(-U*A./(Qa0*rhoCp_a)));
    try
        % crossing.m
        % http://www.mathworks.com/matlabcentral/fileexchange/2432-crossing
        [~,T_Edos_Est]=crossing(qrem-qgen,T);
        C_Edos_Est=interp1(T,C',T_Edos_Est)';
        Ta_Edos_Est=interp1(T,Ta,T_Edos_Est);
        r_Edos_Est=interp1(T,r',T_Edos_Est)';
        k_Edos_Est=interp1(T,k',T_Edos_Est)';
        qrem_Edos_Est=interp1(T,qrem,T_Edos_Est);
        qgen_Edos_Est=interp1(T,qgen,T_Edos_Est);
    catch exception
        if strcmp(exception.message,...
                'No zero crossings found in this sample for fzero')
            T_Edos_Est=NaN;
            C_Edos_Est=NaN;
            Ta_Edos_Est=NaN;
            r_Edos_Est=NaN;
            k_Edos_Est=NaN;
            qrem_Edos_Est=NaN;
            qgen_Edos_Est=NaN;
        end
    end       
elseif ~Estacionario
    if Isot
        T=T0;
        if Incompresible
            M=eye(nComps+1);%cm/min
            odeOptions=odeset('Mass',M,'OutputFcn',@odeprog,...
                'Events',@odeabort);
            %Resolver IVP para sistema de EDO
            %Considerar forma M*y'=f(z,y), especificar f(z,y) como
            %@(z,y)
            sol=ode15s(@(t,y)...
                ...
                [...
                Q0/Vr*(C0'-y(1:end-1))+...
                Coefs_esteq'*rapideces(y(1:end-1),...
                T0,Exponentes_r,k0,E,R,T0ref);...  
                ...
                Qa0/Va*(Ta0-y(end))+...
                -U*A./(Va*rhoCp_a).*...
                (y(end)-Ta0)/log((y(end)-T0)/(Ta0-T0));...
                ]...
                ...
                ,[0,tiempo_tot],[C0,Ta0+1e-10],odeOptions);
            t=sol.x;
            C=sol.y(1:end-1,:);
            T=T0*ones(size(t));
            Ta=sol.y(end,:);
        elseif ~Incompresible
        end
    elseif ~Isot
        if Incompresible
            M=eye(nComps+2);%cm/min
            M(1:end-1,1:end-1)=M(1:end-1,1:end-1);
            M(end,end)=M(end,end);
            odeOptions=odeset('Mass',M,'OutputFcn',@odeprog,...
                'Events',@odeabort);
            %Resolver IVP para sistema de EDO
            %Considerar forma M*y'=f(z,y), especificar f(z,y) como
            %@(z,y)
            sol=ode15s(@(t,y)...
                ...
                [...
                Q0/Vr*(C0'-y(1:end-2))+...
                Coefs_esteq'*rapideces(y(1:end-2),...
                y(end-1),Exponentes_r,k0,E,R,T0ref);...
                ...
                Q0/Vr*(CpMolares*C0'./(CpMolares*y(1:end-2))).*...
                (T0-y(end-1))+...
                (1./(CpMolares*y(1:end-2))).*...
                (-delta_Hr(y(end-1),delta_Hf,Coefs_esteq,CpMolares)*...
                rapideces(y(1:end-2),...
                y(end-1),Exponentes_r,k0,E,R,T0ref))+...
                +U*A./(Vr*CpMolares*y(1:end-2)).*...
                (y(end)-Ta0)/log((y(end)-y(end-1))/(Ta0-y(end-1)));...
                ...
                Qa0/Va*(Ta0-y(end))+...
                -U*A./(Va*rhoCp_a).*...
                (y(end)-Ta0)/log((y(end)-y(end-1))/(Ta0-y(end-1)));...                
                ]...
                ...
                ,[0,tiempo_tot],...
                [C_t0,T_t0,Ta0+1e-10],odeOptions);
            t=sol.x;
            C=sol.y(1:end-2,:);
            T=sol.y(end-1,:);
            Ta=sol.y(end,:);
        elseif ~Incompresible
        end
    end
    [r,k]=rapideces(C,T,Exponentes_r,k0,E,R,T0ref);
    rho_Cp=CpMolares*C;
    qgen=1./(rho_Cp).*(sum(...
        (-delta_Hr(T,delta_Hf,Coefs_esteq,CpMolares))'.*r...
        ,1));
    qrem=-Q0/Vr*(CpMolares*C0'./(CpMolares*C)).*...
        (T0-T)+...
        -(Qa0*rhoCp_a)./(Vr*rho_Cp).*(Ta0-T)*(1-exp(-U*A./(Qa0*rhoCp_a)));
    Qa=Qa0*ones(size(T));
    T_Edos_Est=Datos_struct.T_Edos_Est;
    C_Edos_Est=Datos_struct.C_Edos_Est;
    Ta_Edos_Est=Datos_struct.Ta_Edos_Est;
    r_Edos_Est=Datos_struct.r_Edos_Est;
    k_Edos_Est=Datos_struct.k_Edos_Est;
    qrem_Edos_Est=Datos_struct.qrem_Edos_Est;
    qgen_Edos_Est=Datos_struct.qgen_Edos_Est;
end

Q=Q0*ones(size(T));

X=NaN*zeros(size(C));
Y=NaN*zeros(size(C));
S=NaN*zeros(size(C));
Yconsumo=NaN*zeros(size(C));
%CONVERSIÓN
for j=1:size(C,1)
    if ismember(j,reactivosSonCompsNo)
        X(j,:)=...
                (Q0*C0(j)-Q0*C(j,:))./...
                (Q0*C0(j));
    end
end
%RENDIMIENTO POR ALIMENTACIÓN
for j=1:size(C,1)
    if ismember(j,productosSonCompsNo)
        Y(j,:)=...
                (Q0*C(j,:)-Q0*C0(j))./...
                (Q0*C0(Ref_Rendimiento));     
    end
end
%RENDIMIENTO POR CONSUMO
for j=1:size(C,1)
    if ismember(j,productosSonCompsNo)
        Yconsumo(j,:)=Y(j,:)./X(Ref_Rendimiento,:);
    end
end
%SELECTIVIDAD
for j=1:size(C,1)
    if j~=Ref_Selectividad && ismember(j,productosSonCompsNo)
       S(j,:)=Y(j,:)./Y(Ref_Selectividad,:);
    end
end

warning('off','all');
if Estacionario    
    Q_Edos_Est=interp1(T,Q,T_Edos_Est);
    Qa_Edos_Est=interp1(T,Qa,T_Edos_Est);
    X_Edos_Est=interp1(T,X',T_Edos_Est)';
    Y_Edos_Est=interp1(T,Y',T_Edos_Est)';
    Yconsumo_Edos_Est=interp1(T,Yconsumo',T_Edos_Est)';
    S_Edos_Est=interp1(T,S',T_Edos_Est)';
elseif ~Estacionario    
    Q_Edos_Est=Datos_struct.Q_Edos_Est;
    Qa_Edos_Est=Datos_struct.Qa_Edos_Est;
    X_Edos_Est=Datos_struct.X_Edos_Est;
    Y_Edos_Est=Datos_struct.Y_Edos_Est;
    Yconsumo_Edos_Est=Datos_struct.Yconsumo_Edos_Est;
    S_Edos_Est=Datos_struct.S_Edos_Est;
end
warning('on','all');

Datos_struct.sol=sol;
Datos_struct.t=t;
Datos_struct.C=C;
Datos_struct.X=X;
Datos_struct.Y=Y;
Datos_struct.Yconsumo=Yconsumo;
Datos_struct.S=S;
Datos_struct.T=T;
Datos_struct.Ta=Ta;
Datos_struct.T_Edos_Est=T_Edos_Est;
Datos_struct.r=r;
Datos_struct.k=k;
Datos_struct.qgen=qgen;
Datos_struct.qrem=qrem;
Datos_struct.q={qrem;qgen};
Datos_struct.Qa=Qa;
Datos_struct.Q=Q;

Datos_struct.C_Edos_Est=C_Edos_Est;
Datos_struct.X_Edos_Est=X_Edos_Est;
Datos_struct.Y_Edos_Est=Y_Edos_Est;
Datos_struct.Yconsumo_Edos_Est=Yconsumo_Edos_Est;
Datos_struct.S_Edos_Est=S_Edos_Est;
Datos_struct.T_Edos_Est=T_Edos_Est;
Datos_struct.Ta_Edos_Est=Ta_Edos_Est;
Datos_struct.r_Edos_Est=r_Edos_Est;
Datos_struct.k_Edos_Est=k_Edos_Est;
Datos_struct.qgen_Edos_Est=qgen_Edos_Est;
Datos_struct.qrem_Edos_Est=qrem_Edos_Est;
Datos_struct.q_Edos_Est=...
    {qrem_Edos_Est;qgen_Edos_Est};
Datos_struct.Qa_Edos_Est=Qa_Edos_Est;
Datos_struct.Q_Edos_Est=Q_Edos_Est;

Datos_struct_final=Datos_struct;

end
##### SOURCE END #####
--></body></html>